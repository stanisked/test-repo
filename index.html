<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peone MiniApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>–ü—Ä–æ—Ñ–∏–ª—å Peone</h1>
  <form id="profile-form">
    <img id="avatar" class="avatar" src="" alt="Avatar" />
    <label>–ò–º—è</label>
    <input type="text" name="name" required />

    <label>–ò–Ω—Ç–µ—Ä–µ—Å—ã</label>
    <input type="text" name="interests" />

    <label>–û —Å–µ–±–µ</label>
    <textarea name="bio" rows="3"></textarea>

    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <div id="status"></div>
  </form>

  <section id="nearby-section">
    <h2>–°–æ—Å–µ–¥–∏ —Ä—è–¥–æ–º üß≠</h2>
    <button id="find-nearby-btn">–ù–∞–π—Ç–∏ —Å–æ—Å–µ–¥–µ–π</button>
    <div id="nearby-list"></div>
  </section>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const form = document.getElementById('profile-form');
    const avatarEl = document.getElementById('avatar');
    const statusEl = document.getElementById('status');

    const telegram_id = tg.initDataUnsafe?.user?.id || 123456; // fallback ID

    async function loadProfile() {
      try {
        const res = await fetch(`/api/profile/${telegram_id}`);
        const data = await res.json();

        if (data) {
          form.name.value = data.name || '';
          form.interests.value = data.interests || '';
          form.bio.value = data.bio || '';
          if (data.avatar_url) avatarEl.src = data.avatar_url;
        }
      } catch (err) {
        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', err);
      }
    }

    async function getLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) return resolve({});
        navigator.geolocation.getCurrentPosition(
          pos => resolve({
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude
          }),
          () => resolve({})
        );
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω—è–µ–º...';

      const geo = await getLocation();
      const payload = {
        telegram_id,
        name: form.name.value,
        interests: form.interests.value,
        bio: form.bio.value,
        ...geo
      };

      try {
        const res = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          statusEl.textContent = '‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω';
        } else {
          statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
        statusEl.textContent = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
      }
    });

    loadProfile();
  </script>
</body>
</html>
